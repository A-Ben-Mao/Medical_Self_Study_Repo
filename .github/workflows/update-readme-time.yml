name: Auto Update README Module Last Updated Time

on:
  push:
    branches:
      - main
      - master

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ⭐ 拉完整历史，避免 HEAD~1 问题

      - name: Update module last updated date in README
        run: |
          if [ ! -f README.md ]; then
            exit 0
          fi

          TODAY=$(TZ=Asia/Shanghai date "+%Y-%m-%d")

          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"

          # 如果是第一次提交，before 会是全 0
          if [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git show --name-only --pretty="" "$AFTER_SHA")
          else
            CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$AFTER_SHA")
          fi

          update_last_time() {
            MODULE="$1"
            sed -i "s/^\(| ${MODULE} | [^|]* | [0-9\-]\+ | \).*\(|\)$/\1${TODAY}\2/" README.md
          }

          for file in $CHANGED_FILES; do
            case "$file" in
              repo/Bulk_RNA-seq.md)
                update_last_time "普通转录组学"
                ;;
              repo/Radiomics.md)
                update_last_time "颅脑影像处理"
                ;;
              repo/Cell_experiments.md)
                update_last_time "细胞实验基础"
                ;;
              repo/Ethology.md)
                update_last_time "常见动物行为学实验"
                ;;
              repo/Data_processing.md)
                update_last_time "常用实验数据处理"
                ;;
            esac
          done

          if ! git diff --quiet README.md; then
            sed -i "s/后续将持续更新，最近一次更新时间为：.*/后续将持续更新，最近一次更新时间为：${TODAY}/" README.md
          fi

      - name: Commit and push if README changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No README changes."
            exit 0
          fi

          git add README.md
          git commit -m "docs: auto update module last updated date"
          git push
