name: Auto Update README Module Dates

on:
  push:
    branches:
      - main
      - master

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update README module dates
        run: |
          if [ ! -f README.md ]; then
            exit 0
          fi

          TODAY=$(TZ=Asia/Shanghai date "+%Y-%m-%d")

          # 获取本次 push 中变更的文件
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          update_row() {
            MODULE="$1"
            sed -i "s/^\(| ${MODULE} | [0-9\-]\+ | \).*\(|\)$/\1${TODAY}\2/" README.md
          }

          for file in $CHANGED_FILES; do
            case "$file" in
              repo/Bulk_RNA-seq.md)
                update_row "普通转录组学"
                ;;
              repo/Radiomics.md)
                update_row "颅脑影像处理"
                ;;
              repo/Cell_experiments.md)
                update_row "细胞实验基础"
                ;;
              repo/Ethology.md)
                update_row "常见动物行为学实验"
                ;;
              Data_processing.md)
                update_row "常用实验数据处理"
                ;;
            esac
          done

          # 更新 README 底部“最近一次更新时间”
          if [ -n "$CHANGED_FILES" ]; then
            sed -i "s/后续将持续更新，最近一次更新时间为：.*/后续将持续更新，最近一次更新时间为：${TODAY}/" README.md
          fi

      - name: Commit and push if needed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No README changes."
            exit 0
          fi

          git add README.md
          git commit -m "docs: auto update module update dates"
          git push
